<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>تسجيل غياب الطلبة بمدرسة آسية بنت مزاحم </title>
<style>
    body { font-family: 'Tajawal', sans-serif; background: #f4f4f4; color: #111; padding: 20px; direction: rtl; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: right; }
    th { background: #eee; }
    button, select, input { padding: 6px 12px; margin-left: 10px; border: 1px solid #ccc; border-radius: 6px; }
    button { cursor: pointer; }
    .present { background: #16a34a; color: #fff; }
    .absent { background: #dc2626; color: #fff; }
    .controls { margin-bottom: 20px; }
  </style>
</head>
<body>
<div style="position: absolute; top: 10px; left: 10px; font-size: 13px; color: #555;">تصميم / سيف جمال المعولي</div>
<h2>تسجيل غياب الطلبة بمدرسة آسية بنت مزاحم</h2>
<div class="controls">
<label>اسم المعلم: <input id="teacherName" placeholder="اكتب اسم المعلم" type="text"/></label>
<label>الصف:
    <select id="gradeSelect" onchange="updateSections()">
<option value="">اختر</option>
<option value="5">الصف الخامس</option>
<option value="6">الصف السادس</option>
<option value="7">الصف السابع</option>
<option value="8">الصف الثامن</option>
<option value="9">الصف التاسع</option>
<option value="10">الصف العاشر</option>
<option value="11">الصف الحادي عشر</option>
<option value="12">الصف الثاني عشر</option>
</select>
</label>
<label>الشعبة:
    <select id="sectionSelect">
<option value="">اختر</option>
</select>
</label>
<button onclick="loadCSVData()">عرض الطلاب</button>
<button onclick="exportToGoogleSheet()">📤 إرسال إلى Google Sheets</button><button id="noAbsenceBtn" style="background-color: #f44336; color: white; margin-right: 10px; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer;" type="button">🚫 لا يوجد غياب</button>
</div>
<table>
<thead>
<tr>
<th>#</th>
<th>الاسم</th>
<th>الهاتف</th>
<th>الحالة</th>
</tr>
</thead>
<tbody id="studentsBody">
<tr><td colspan="4">بانتظار تحميل البيانات...</td></tr>
</tbody>
</table>
<p>
  الغائبون: <span id="absCount">0</span> — الحاضرون: <span id="presCount">0</span>
</p>
<script>
const SHEET_URLS = [
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vS2UZiEif_61URUco08HBhbHRcQoZmD5R3gwCgHel50t4ltWToPHV84DC4zPgxjFA/pub?gid=626465739&single=true&output=csv'
];
const EXPORT_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycby6oN2AGVUfJFg03Kywwl7ZHEdoLBvF4KchZLwOIt0qstuQ15u4hrXY0ANWDCOTrN5xFg/exec';
const $ = selector => document.querySelector(selector);
const state = { students: [], attendance: {} };

function updateCounts() {
  let absent = 0, present = 0;
  state.students.forEach(s => state.attendance[s.id] === false ? absent++ : present++);
  $('#absCount').textContent = absent;
  $('#presCount').textContent = present;
}

function renderStudents() {
  const tbody = $('#studentsBody');
  tbody.innerHTML = '';

  state.students.forEach((student, index) => {
    if (!(student.id in state.attendance)) {
      state.attendance[student.id] = true;
    }
    const present = state.attendance[student.id];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${student.name}</td>
      <td>${student.phone}</td>
    `;
    const tdStatus = document.createElement('td');
    const btn = document.createElement('button');
    btn.textContent = present ? 'حاضر' : 'غائب';
    btn.className = present ? 'present' : 'absent';
    btn.onclick = () => {
      state.attendance[student.id] = !state.attendance[student.id];
      renderStudents();
    };
    tdStatus.appendChild(btn);
    tr.appendChild(tdStatus);
    tbody.appendChild(tr);
  });

  updateCounts();
}

async function loadCSVData() {
  const grade = $('#gradeSelect').value.trim();
  const section = $('#sectionSelect').value.trim();
  if (!grade || !section) {
    alert('يرجى اختيار الصف والشعبة');
    return;
  }

  try {
    let combinedText = '';
    for (const url of SHEET_URLS) {
      const res = await fetch(url);
      if (!res.ok) continue;
      const text = await res.text();
      combinedText += text.trim() + '\n';
    }
    const lines = combinedText.trim().split('\n');

    state.students = lines.slice(1).map((line, i) => {
      const cols = line.split(',');
      return {
        id: i + 1,
        phone: cols[0]?.trim() || '',
        name: cols[1]?.trim() || '',
        grade: cols[3]?.trim() || '',
        section: cols[4]?.trim() || ''
      };
    }).filter(s => s.grade === grade && s.section === section);

    renderStudents();
  } catch (err) {
    $('#studentsBody').innerHTML = `<tr><td colspan="4">تعذر تحميل البيانات</td></tr>`;
    console.error(err);
  }
}

function exportToGoogleSheet() {
  const absents = state.students.filter(s => state.attendance[s.id] === false);
  if (!absents.length) return alert('لا يوجد غياب لتصديره.');
  const teacher = $('#teacherName').value.trim() || 'المعلم';
  const grade = $('#gradeSelect').value;
  const section = $('#sectionSelect').value;
  const today = new Date().toLocaleDateString('ar-EG');

  const rows = absents.map((s, i) => ({
    serial: i + 1,
    phone: formatPhoneOM(s.phone),
    name: s.name,
    message: `ولي أمر الطالب ${s.name}، نعلمكم بغياب ابنكم عن الصف ${grade}/${section} بتاريخ ${today}. — ${teacher}`
  }));

  fetch(EXPORT_WEBAPP_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(rows)
  }).then(() => {
    alert('✅ تم إرسال الغياب إلى جدول Google بنجاح');
    // إعادة تعيين الصفحة بعد الإرسال
    location.reload();
    alert('✅ تم إرسال الغياب إلى جدول Google بنجاح');
  }).catch(err => {
    alert('❌ فشل الإرسال إلى الشيت');
    console.error(err);
  });
}

function formatPhoneOM(raw) {
  const cleaned = raw.replace(/[^\d]/g, '');
  if (cleaned.startsWith('968')) return cleaned;
  if (cleaned.startsWith('0')) return '968' + cleaned.slice(1);
  if (cleaned.length === 8) return '968' + cleaned;
  return '';
}

function updateSections() {
  const grade = $('#gradeSelect').value;
  const sectionSelect = $('#sectionSelect');
  sectionSelect.innerHTML = '<option value="">اختر</option>';
  let count = 3;
  if (grade === '10') count = 4;
  else if (grade === '11') count = 6;
  else if (grade === '12') count = 5;

  for (let i = 1; i <= count; i++) {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = 'الشعبة ' + i;
    sectionSelect.appendChild(opt);
  }
}
</script>
<div style="position: fixed; bottom: 10px; left: 10px; font-size: 13px; color: #555;">تصميم / سيف جمال المعولي</div>
<script>
document.getElementById("noAbsenceBtn").addEventListener("click", function () {
  const teacher = document.getElementById("teacherName").value.trim();
  const grade = document.getElementById("gradeSelect").value;
  const section = document.getElementById("sectionSelect").value;
  if (!teacher || !grade || !section) {
    alert("يرجى إدخال اسم المعلم واختيار الصف والشعبة أولاً.");
    return;
  }

  const today = new Date().toLocaleDateString('ar-EG');
  const payload = [{
    serial: "-",
    phone: "-",
    name: "-",
    message: `المعلم: ${teacher}\nالصف: ${grade}\nالشعبة: ${section}\nلا يوجد غياب في هذا الصف بتاريخ ${today}`
  }];

  fetch(EXPORT_WEBAPP_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).then(() => {
    alert('✅ تم إرسال إشعار عدم وجود غياب بنجاح');
    location.reload();
  }).catch(err => {
    alert('❌ فشل في إرسال إشعار عدم وجود غياب');
    console.error(err);
  });
});
</script></body>
</html>
